@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var jwtToken = Context.Session.GetString("JWTToken");
}

<h2>Welcome, Admin 🛠️</h2>
<p class="text-muted">Overview of the system</p>

<div class="row g-3 mt-3">
    <div class="col-md-4">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5>Registered Users</h5>
                <p id="totalUsers" class="display-6 text-primary">--</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5>Active Exams</h5>
                <p id="activeExams" class="display-6 text-success">--</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5>Total Payments</h5>
                <p id="totalPayments" class="display-6 text-info">₹--</p>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <h4>Recent Submissions</h4>
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>User</th>
                <th>Exam</th>
                <th>Submitted At</th>
            </tr>
        </thead>
        <tbody id="recentSubmissions">
            <tr><td colspan="4">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>

    const jwtToken = '@jwtToken'.trim();

    if (!jwtToken || jwtToken === "null" || jwtToken === "") {
        alert("Session expired. Please log in again.");
        window.location.href = "/Account/Login";
    }

    async function loadDashboard() {
        try {
            const response = await fetch("https://localhost:7267/api/Admin/admin-stats", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + jwtToken
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    alert("Unauthorized! Please log in again.");
                    window.location.href = "/Account/Login";
                    return;
                }
                throw new Error("Failed to load dashboard data");
            }

            const data = await response.json();
            console.log("Dashboard data:", data);

   
            document.getElementById("totalUsers").innerText = data.totalUsers;
            document.getElementById("activeExams").innerText = data.activeExams;
            document.getElementById("totalPayments").innerText = "₹" + data.totalPayments.toLocaleString();

        
            const tbody = document.getElementById("recentSubmissions");
            tbody.innerHTML = "";

            if (data.recentSubmissions && data.recentSubmissions.length > 0) {
                data.recentSubmissions.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.userName}</td>
                        <td>${item.formTitle}</td>
                        <td>${item.submittedAt}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4">No recent submissions</td></tr>`;
            }

        } catch (error) {
            console.error("Error loading dashboard:", error);
            alert("Error loading dashboard data: " + error.message);
        }
    }

    loadDashboard();
</script>
